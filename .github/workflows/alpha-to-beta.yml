name: "Beta stage - Move alpha to beta"

on:
  workflow_dispatch:
    inputs:
      version_for_beta_channel:
        description: 'Version of alpha app in format {major}-{minor}-{patch}-{build_nr}'
        required: true

jobs:
  build:
    runs-on: buildjet-8vcpu-ubuntu-2204

    steps:
      - name: Sourcecode Checkout
        uses: actions/checkout@v3

      - name: Get Google Cloud Platform access
        uses: google-github-actions/setup-gcloud@v0.2.1
        with:
          project_id: 'ocff-infra-artifacts-v1'
          service_account_key: ${{ secrets.GOOGLE_BUCKET_CREDENTIALS }}
          export_default_credentials: true

      - name: Check that an alpha build exists (Google Cloud Storage)
        run: ./.github/workflows/scripts/stageExistsCheck.sh ${{ github.event.inputs.version_for_beta_channel }} alpha hubis-app
        shell: bash

      - name: Check that no beta build exists (Google Cloud Storage)
        run: ./.github/workflows/scripts/stageDoesntExistsCheck.sh ${{ github.event.inputs.version_for_beta_channel }} beta hubis-app
        shell: bash

      - name: Check that no GA build exists (Google Cloud Storage)
        run: ./.github/workflows/scripts/stageDoesntExistsCheck.sh ${{ github.event.inputs.version_for_beta_channel }} ga hubis-app
        shell: bash

      - name: Copy APK from alpha to beta channel (Google Cloud Storage)
        run: |
          GCS_PATH_FROM=gs://ocff-deployment-mobileapps/hubis-app/releases/${{ github.event.inputs.version_for_beta_channel }}/alpha
          GCS_PATH_TO=gs://ocff-deployment-mobileapps/hubis-app/releases/${{ github.event.inputs.version_for_beta_channel }}/beta
          gcloud storage cp -r GCS_PATH_FROM GCS_PATH_TO
